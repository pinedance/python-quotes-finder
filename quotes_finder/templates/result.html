<!DOCTYPE html>
<html lang="ko" class="">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <style>

    html {
      min-height:100%;/* make sure it is at least as tall as the viewport */
      position:relative;
    }

    body {
        height:100%; /* force the BODY element to match the height of the HTML element */
    }

    .text {
      height: 600px;
      overflow-y: scroll;
    }

    .highlight-0 {
    }

    .highlight-1 {
        background-color: #fff9c4;
    }

    .highlight-2 {
        background-color: #fff176;
    }

    .highlight-3 {
        background-color: #ffeb3b;
    }

    .highlight-4 {
        background-color: #ffecb3;
    }

    .highlight-5 {
        background-color: #ffd54f;
    }

    .highlight-6 {
        background-color: #ffc107;
    }

    .highlight-7 {
        background-color: #ffe0b2;
    }

    .highlight-8 {
        background-color: #ffb74d ;
    }

    .highlight-9 {
        background-color: #ff9800 ;
    }

    </style>
</head>

<body>

<div class="container">
  <div class="row">
    <div id="common-btn"></div>
  </div>
  <div class="row">
    <div class="col-sm-6">
        <div id="ref-btn"></div>
    </div>
    <div class="col-sm-6">
        <div id="trg-btn"></div>
    </div>
  </div>
  <div class="row">
    <div class="col-sm-6 text card card-body bg-light" id="ref-text">

    </div>
    <div class="col-sm-6 text card card-body bg-light" id="trg-text">

    </div>
  </div>
</div>

<div id="text"></div>

<script>


let ref_text = `{{REF_TEXT}}`

let trg_text = `{{TRG_TEXT}}`

let ref_indices = {{REF_INDICES}}

let trg_indices = {{TRG_INDICES}}



let ref_text_tag = document.getElementById("ref-text")
let trg_text_tag = document.getElementById("trg-text")
let ref_text_len = ref_text.length
let trg_text_len = trg_text.length

let ref_indices_len = ref_indices.length
let trg_indices_len = trg_indices.length

let ref_traced, trg_traced
[ref_traced, trg_traced] = traceText()

let ref_text_seg = mergeTraceText(ref_traced)
let trg_text_seg = mergeTraceText(trg_traced)

function traceText(){

    // let ref_space_count = new Array( ref_text_len+1 ).fill(0);
    let ref_space_idx = new Array( ref_text_len+1 ) //.fill( new Array() );
    // let trg_space_count = new Array( trg_text_len+1 ).fill(0);
    let trg_space_idx = new Array( trg_text_len+1 ) //.fill( new Array() );

    ref_indices.forEach( function(e, i, arr){
          let ref_start, ref_stop, trg_start, trg_stop
          [[ref_start, ref_stop], [trg_start, trg_stop]] = e

          for (let j=ref_start; j<ref_stop; j++){
              // ref_space_count[j] += 1
              if ( ref_space_idx[j] ){
                  ref_space_idx[j].push( i )
              } else {
                  ref_space_idx[j] = [i]
              }
          }

          for (let k=trg_start; k<trg_stop; k++){
              // trg_space_count[k] += 1
              if ( trg_space_idx[k] ){
                  trg_space_idx[k].push( i )
              } else {
                  trg_space_idx[k] = [i]
              }
          }

    })

    return [ref_space_idx, trg_space_idx]
}

function mergeTraceText( traced ){
    let last_var = traced[0]
    let start = 0
    let rst = []

    traced.forEach(function(e, i, arr){
        last_var = arr[i-1] || []
        if ( e && ( JSON.stringify( e ) == JSON.stringify( last_var ) ) ){
            // continue;
        } else {
            rst.push( [ [start, i], last_var ] )
            start = i
        }
    })
    rst.push( [ [start, traced.length], traced[traced.length-1] || [] ] )
    return rst
}

function createSpanFunc( type, whole_text, indices_len ){
    return function( e, i, arr ){
        let start, stop, idx_arr
        [[start, stop], idx_arr] = e
        let span = document.createElement("span");
        if (idx_arr.length > 0){
            span.id = type + "-" + idx_arr[0];
        }
        span.innerHTML = whole_text.slice( start, stop ) + addShoulderNum( type, idx_arr );
        let brightness = idx_arr.length
        span.classList.add( "highlight-" + String( ( brightness < 9 )? brightness : 9 ) )
        return span
    }
}

function addShoulderNum( type, idx_arr ){
    let shoulder_nums = idx_arr.map(function(e,i,arr){
        let other_type = (type == "Ref")? "Trg" : "Ref"
        return '<sup><a class="shoulder-num" href="#' + other_type + '-' + e + '" >' + "[" + e + "]" + "</a></sup>"
    })
    return shoulder_nums.join("")
}

function createButton(context, func, label) {
    var button = document.createElement("input");
    button.type = "button";
    button.value = label;
    button.onclick = func;
    context.appendChild(button);
}

function refreshContents(){
      // console.log( ref_text_seg )
      // console.log( trg_text_seg )

      let ref_text_span = ref_text_seg.map( createSpanFunc( 'Ref', ref_text, ref_indices_len ) )
      let trg_text_span = trg_text_seg.map( createSpanFunc( 'Trg', trg_text, ref_indices_len ) )

      ref_text_span.forEach(function(e,i,arr){
          ref_text_tag.appendChild( e )
      })

      trg_text_span.forEach(function(e,i,arr){
          trg_text_tag.appendChild( e )
      })
      document.getElementById('ref-text').scrollIntoView();
      document.getElementById('trg-text').scrollIntoView();
}

function createButtonFunc( item, index ){
    return function(){

        var ref_start, ref_stop, trg_start, trg_stop
        [[ref_start, ref_stop], [trg_start, trg_stop]] = item

        var ref = {
          head: document.createElement("span"),
          body: document.createElement("span"),
          tail: document.createElement("span"),
        }

        ref.head.id = "ref-text-head"
        ref.body.id = "ref-text-body"
        ref.body.style = "color: blue;"
        ref.tail.id = "ref-text-tail"

        ref.head.innerText = ref_text.slice(0, ref_start)
        ref.body.innerText = ref_text.slice(ref_start, ref_stop)
        ref.tail.innerText = ref_text.slice(ref_stop, ref_text_len)

        ref_text_tag.innerText = ""
        ref_text_tag.appendChild(ref.head)
        ref_text_tag.appendChild(ref.body)
        ref_text_tag.appendChild(ref.tail)

        var trg = {
          head: document.createElement("span"),
          body: document.createElement("span"),
          tail: document.createElement("span"),
        }

        trg.head.id = "trg-text-head"
        trg.body.id = "trg-text-body"
        trg.body.style = "color: blue;"
        trg.tail.id = "trg-text-tail"

        trg.head.innerText = trg_text.slice(0, trg_start)
        trg.body.innerText = trg_text.slice(trg_start, trg_stop)
        trg.tail.innerText = trg_text.slice(trg_stop, trg_text_len)

        trg_text_tag.innerText = ""
        trg_text_tag.appendChild(trg.head)
        trg_text_tag.appendChild(trg.body)
        trg_text_tag.appendChild(trg.tail)

        document.getElementById('ref-text-body').scrollIntoView();
        document.getElementById('ref-text').scrollBy(0, -100);
        document.getElementById('trg-text-body').scrollIntoView();
        document.getElementById('trg-text').scrollBy(0, -100);
    }
}

window.onload = function() {

    refreshContents()


//
    let common_btn = document.getElementById("common-btn")
    let ref_btn = document.getElementById("ref-btn")
    let trg_btn = document.getElementById("trg-btn")
    createButton( common_btn, refreshContents, "refresh" )
    ref_indices.forEach(function (item, index, array) {
        createButton( ref_btn, createButtonFunc(item, index), "REF"+String(index+1) )
    });
    trg_indices.forEach(function (item, index, array) {
        createButton( trg_btn, createButtonFunc(item, index), "TRG"+String(index+1) )
    });



};


</script>
</body>
